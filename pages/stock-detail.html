<!-- Stock Detail Page - Robinhood Style -->
<div class="stock-detail">
    <!-- Header with Price -->
    <div class="stock-detail-header">
        <div class="stock-detail-symbol" id="stock-symbol-label">AAPL</div>
        <h1 class="stock-detail-name" id="stock-name">Apple Inc.</h1>

        <div class="stock-detail-price" id="stock-price">$0.00</div>
        <div class="stock-detail-change positive" id="stock-change">
            <span>+$0.00 (0.00%)</span>
            <span>Today</span>
        </div>
        <div class="stock-detail-market-status" id="market-status">Market Closed</div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
        <div id="stock-main-chart" style="width: 100%; height: 300px;"></div>

        <div class="chart-timeframes">
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('1D')">1D</button>
            <button class="chart-timeframe-btn active" onclick="StockDetail.changeTimeframe('1W')">1W</button>
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('1M')">1M</button>
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('3M')">3M</button>
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('YTD')">YTD</button>
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('1Y')">1Y</button>
            <button class="chart-timeframe-btn" onclick="StockDetail.changeTimeframe('5Y')">5Y</button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid-modern">
        <div class="stat-item">
            <div class="stat-label">Volume</div>
            <div class="stat-value" id="stat-volume">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Avg Volume</div>
            <div class="stat-value" id="stat-avg-volume">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Open</div>
            <div class="stat-value" id="stat-open">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Previous Close</div>
            <div class="stat-value" id="stat-prev-close">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Today's High</div>
            <div class="stat-value" id="stat-high">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Today's Low</div>
            <div class="stat-value" id="stat-low">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Market Cap</div>
            <div class="stat-value" id="stat-market-cap">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">P/E Ratio</div>
            <div class="stat-value" id="stat-pe-ratio">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">52 Week High</div>
            <div class="stat-value" id="stat-52w-high">--</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">52 Week Low</div>
            <div class="stat-value" id="stat-52w-low">--</div>
        </div>
    </div>

    <!-- Options Section -->
    <div class="options-section">
        <h2 class="section-title">Options Signals</h2>
        <div class="options-list" id="options-signals-list">
            <!-- Loading state -->
            <div class="option-item">
                <div class="option-info">
                    <div class="skeleton" style="width: 100px; height: 20px; margin-bottom: 4px;"></div>
                    <div class="skeleton" style="width: 200px; height: 16px;"></div>
                </div>
                <div class="option-price">
                    <div class="skeleton" style="width: 60px; height: 20px; margin-bottom: 4px;"></div>
                    <div class="skeleton" style="width: 70px; height: 16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Section -->
    <div class="news-section">
        <h2 class="section-title">News & Updates</h2>
        <div id="stock-news-list">
            <!-- Loading state -->
            <div class="news-item">
                <div class="news-content" style="flex: 1;">
                    <div class="skeleton" style="width: 80px; height: 14px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 90%; height: 18px; margin-bottom: 4px;"></div>
                    <div class="skeleton" style="width: 70%; height: 18px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 100px; height: 14px;"></div>
                </div>
                <div class="skeleton" style="width: 80px; height: 80px; border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <!-- Trade Button -->
    <button class="btn-trade" onclick="StockDetail.openTradeDialog()">
        Trade Options
    </button>
</div>

<script>
const StockDetail = {
    symbol: null,
    chart: null,
    currentTimeframe: '1W',

    async init() {
        // Get symbol from URL path (e.g., /stock/AAPL)
        const pathParts = window.location.pathname.split('/');
        this.symbol = pathParts[pathParts.length - 1] || 'AAPL';

        console.log('Loading stock detail for:', this.symbol);

        // Load all data
        await Promise.all([
            this.loadStockData(),
            this.loadOptions(),
            this.loadNews()
        ]);

        // Initialize chart
        this.initChart();
    },

    async loadStockData() {
        try {
            // In production, fetch from real API
            // For now, use mock data
            const mockData = this.getMockStockData(this.symbol);

            // Update header
            document.getElementById('stock-symbol-label').textContent = this.symbol;
            document.getElementById('stock-name').textContent = mockData.name;
            document.getElementById('stock-price').textContent = `$${mockData.price.toFixed(2)}`;

            const changeElem = document.getElementById('stock-change');
            const isPositive = mockData.change >= 0;
            changeElem.className = `stock-detail-change ${isPositive ? 'positive' : 'negative'}`;
            changeElem.innerHTML = `
                <span>${isPositive ? '+' : ''}$${Math.abs(mockData.change).toFixed(2)} (${mockData.change_percent}%)</span>
                <span>Today</span>
            `;

            // Update stats
            document.getElementById('stat-volume').textContent = this.formatVolume(mockData.volume);
            document.getElementById('stat-avg-volume').textContent = this.formatVolume(mockData.avg_volume);
            document.getElementById('stat-open').textContent = `$${mockData.open.toFixed(2)}`;
            document.getElementById('stat-prev-close').textContent = `$${mockData.prev_close.toFixed(2)}`;
            document.getElementById('stat-high').textContent = `$${mockData.high.toFixed(2)}`;
            document.getElementById('stat-low').textContent = `$${mockData.low.toFixed(2)}`;
            document.getElementById('stat-market-cap').textContent = this.formatMarketCap(mockData.market_cap);
            document.getElementById('stat-pe-ratio').textContent = mockData.pe_ratio.toFixed(2);
            document.getElementById('stat-52w-high').textContent = `$${mockData['52w_high'].toFixed(2)}`;
            document.getElementById('stat-52w-low').textContent = `$${mockData['52w_low'].toFixed(2)}`;

            // Market status
            const now = new Date();
            const hour = now.getHours();
            const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
            const isMarketOpen = isWeekday && hour >= 9 && hour < 16;
            document.getElementById('market-status').textContent = isMarketOpen ? 'Market Open' : 'Market Closed';

        } catch (error) {
            console.error('Error loading stock data:', error);
        }
    },

    async loadOptions() {
        try {
            const response = await fetch(`/api/options/signals?symbols=${this.symbol}&min_confidence=0.65&max_results=10`);
            const signals = await response.json();

            this.renderOptions(signals);
        } catch (error) {
            console.error('Error loading options:', error);
            this.renderOptions([]); // Render empty state
        }
    },

    renderOptions(signals) {
        const container = document.getElementById('options-signals-list');

        if (!signals || signals.length === 0) {
            container.innerHTML = `
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <p>No options signals available for ${this.symbol}</p>
                </div>
            `;
            return;
        }

        container.innerHTML = signals.map(signal => {
            const isPositive = signal.action === 'BUY';
            const changeClass = isPositive ? 'positive' : 'negative';

            return `
                <div class="option-item">
                    <div class="option-info">
                        <div class="option-type">${signal.action} ${signal.option_type.toUpperCase()}</div>
                        <div class="option-details">
                            $${signal.strike} • Exp: ${signal.expiration} • ${(signal.confidence * 100).toFixed(0)}% confidence
                        </div>
                    </div>
                    <div class="option-price">
                        <div class="option-price-value">$${signal.suggested_entry.toFixed(2)}</div>
                        <div class="option-price-change ${changeClass}">
                            Target: $${signal.target.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },

    async loadNews() {
        // Mock news data
        const mockNews = this.getMockNews(this.symbol);
        this.renderNews(mockNews);
    },

    renderNews(newsItems) {
        const container = document.getElementById('stock-news-list');

        if (!newsItems || newsItems.length === 0) {
            container.innerHTML = `
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <p>No recent news for ${this.symbol}</p>
                </div>
            `;
            return;
        }

        container.innerHTML = newsItems.map(item => `
            <div class="news-item" onclick="window.open('${item.url}', '_blank')">
                <div class="news-content">
                    <div class="news-source">${item.source} • ${item.time}</div>
                    <div class="news-title">${item.title}</div>
                    <div class="news-tickers">
                        <span class="news-ticker ${item.sentiment === 'positive' ? 'positive' : 'negative'}">
                            ${this.symbol}
                        </span>
                    </div>
                </div>
                ${item.image ? `<img src="${item.image}" alt="News" class="news-image">` : ''}
            </div>
        `).join('');
    },

    initChart() {
        const container = document.getElementById('stock-main-chart');

        // Create chart
        this.chart = LightweightCharts.createChart(container, {
            layout: {
                background: { color: 'transparent' },
                textColor: '#8E8E93',
            },
            grid: {
                vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#38383A',
            },
            timeScale: {
                borderColor: '#38383A',
                timeVisible: true,
            },
        });

        // Add candlestick series
        const candlestickSeries = this.chart.addCandlestickSeries({
            upColor: '#00C805',
            downColor: '#FF5000',
            borderDownColor: '#FF5000',
            borderUpColor: '#00C805',
            wickDownColor: '#FF5000',
            wickUpColor: '#00C805',
        });

        // Generate mock data
        const chartData = this.generateMockChartData();
        candlestickSeries.setData(chartData);

        // Fit content
        this.chart.timeScale().fitContent();

        // Handle window resize
        window.addEventListener('resize', () => {
            this.chart.applyOptions({ width: container.clientWidth });
        });
    },

    changeTimeframe(timeframe) {
        this.currentTimeframe = timeframe;

        // Update button states
        document.querySelectorAll('.chart-timeframe-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Regenerate chart data for new timeframe
        if (this.chart) {
            const chartData = this.generateMockChartData();
            const candlestickSeries = this.chart.series()[0];
            if (candlestickSeries) {
                candlestickSeries.setData(chartData);
                this.chart.timeScale().fitContent();
            }
        }
    },

    generateMockChartData() {
        const data = [];
        const now = Math.floor(Date.now() / 1000);
        const daySeconds = 86400;

        // Determine number of days based on timeframe
        let days = 7; // Default 1W
        if (this.currentTimeframe === '1D') days = 1;
        else if (this.currentTimeframe === '1M') days = 30;
        else if (this.currentTimeframe === '3M') days = 90;
        else if (this.currentTimeframe === 'YTD') days = 180;
        else if (this.currentTimeframe === '1Y') days = 365;
        else if (this.currentTimeframe === '5Y') days = 1825;

        let price = 150;

        for (let i = days; i >= 0; i--) {
            const time = now - (i * daySeconds);
            const open = price;
            const change = (Math.random() - 0.5) * 5;
            const close = price + change;
            const high = Math.max(open, close) + Math.random() * 2;
            const low = Math.min(open, close) - Math.random() * 2;

            data.push({
                time: time,
                open: open,
                high: high,
                low: low,
                close: close
            });

            price = close;
        }

        return data;
    },

    getMockStockData(symbol) {
        const base = 100 + Math.random() * 400;
        const change = (Math.random() - 0.5) * 10;

        return {
            name: this.getStockName(symbol),
            price: base,
            change: change,
            change_percent: ((change / base) * 100).toFixed(2),
            volume: Math.floor(Math.random() * 100000000),
            avg_volume: Math.floor(Math.random() * 100000000),
            open: base - Math.random() * 5,
            prev_close: base - change,
            high: base + Math.random() * 5,
            low: base - Math.random() * 5,
            market_cap: Math.floor(Math.random() * 3000000000000),
            pe_ratio: 15 + Math.random() * 30,
            '52w_high': base + Math.random() * 50,
            '52w_low': base - Math.random() * 50
        };
    },

    getMockNews(symbol) {
        return [
            {
                source: 'Bloomberg',
                time: '2 hours ago',
                title: `${symbol} Reports Strong Q4 Earnings, Beats Analyst Expectations`,
                url: '#',
                sentiment: 'positive',
                image: null
            },
            {
                source: 'CNBC',
                time: '5 hours ago',
                title: `Why ${symbol} Stock Is Moving Today: Analyst Upgrade`,
                url: '#',
                sentiment: 'positive',
                image: null
            },
            {
                source: 'MarketWatch',
                time: '1 day ago',
                title: `${symbol} Announces New Product Line, Stock Gains 3%`,
                url: '#',
                sentiment: 'positive',
                image: null
            }
        ];
    },

    getStockName(symbol) {
        const names = {
            'NVDA': 'NVIDIA Corporation',
            'TSLA': 'Tesla, Inc.',
            'AAPL': 'Apple Inc.',
            'AMD': 'Advanced Micro Devices, Inc.',
            'MSFT': 'Microsoft Corporation',
            'META': 'Meta Platforms, Inc.',
            'GOOGL': 'Alphabet Inc.',
            'AMZN': 'Amazon.com, Inc.',
            'SPY': 'SPDR S&P 500 ETF Trust',
            'QQQ': 'Invesco QQQ Trust'
        };
        return names[symbol] || `${symbol} Inc.`;
    },

    formatVolume(volume) {
        if (volume >= 1000000000) return `${(volume / 1000000000).toFixed(2)}B`;
        if (volume >= 1000000) return `${(volume / 1000000).toFixed(2)}M`;
        if (volume >= 1000) return `${(volume / 1000).toFixed(2)}K`;
        return volume.toString();
    },

    formatMarketCap(cap) {
        if (cap >= 1000000000000) return `$${(cap / 1000000000000).toFixed(2)}T`;
        if (cap >= 1000000000) return `$${(cap / 1000000000).toFixed(2)}B`;
        if (cap >= 1000000) return `$${(cap / 1000000).toFixed(2)}M`;
        return `$${cap.toLocaleString()}`;
    },

    openTradeDialog() {
        alert(`Trading interface for ${this.symbol} coming soon!\n\nThis will open a modal with:\n- Order type selection (Market/Limit)\n- Quantity input\n- Price confirmation\n- Risk analysis\n- Paper trading execution`);
    }
};

// Initialize when page loads
StockDetail.init();
</script>
