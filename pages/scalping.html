<div class="page-header">
    <h1 class="page-title">‚ö° Scalping Signals</h1>
    <p class="page-subtitle">Fast 0-7 DTE options plays | Quick entries and exits</p>
</div>

<!-- Market Status Banner -->
<div id="market-status-banner" style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border: 1px solid var(--border-color);">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <div id="market-status-icon" style="font-size: 1.5rem;">‚è≥</div>
        <div>
            <div id="market-status-text" style="font-weight: 600; font-size: 0.875rem;">Checking market status...</div>
            <div id="market-status-time" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Loading...</div>
        </div>
    </div>
    <div id="market-countdown" style="font-family: monospace; font-size: 0.875rem; font-weight: 600;"></div>
</div>

<!-- Stats Summary -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Active Signals</div>
        <div class="stat-value" id="scalp-active-count">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avg Confidence</div>
        <div class="stat-value" id="scalp-avg-confidence">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">In Paper Trading</div>
        <div class="stat-value" id="scalp-paper-count">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Win Rate (7d)</div>
        <div class="stat-value stat-up" id="scalp-win-rate">-</div>
    </div>
</div>

<!-- Controls -->
<div class="card mb-3">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
            <div>
                <label style="color: var(--text-secondary); margin-right: 0.5rem;">Min Confidence:</label>
                <select id="scalp-min-confidence" style="padding: 0.5rem; border-radius: 0.375rem; background: var(--dark-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <option value="0.70" selected>70%</option>
                    <option value="0.75">75%</option>
                    <option value="0.80">80%</option>
                    <option value="0.85">85%</option>
                    <option value="0.90">90%</option>
                    <option value="0.95">95%</option>
                </select>
            </div>
            <div>
                <label style="color: var(--text-secondary); margin-right: 0.5rem;">Max Entry Price:</label>
                <select id="scalp-max-price" style="padding: 0.5rem; border-radius: 0.375rem; background: var(--dark-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
                    <option value="0.50">$0.50</option>
                    <option value="1.00">$1.00</option>
                    <option value="2.00">$2.00</option>
                    <option value="3.00">$3.00</option>
                    <option value="5.00" selected>$5.00</option>
                    <option value="10.00">$10.00</option>
                    <option value="50.00">$50.00</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" id="scalp-refresh-btn">üîÑ Refresh Signals</button>
    </div>
</div>

<!-- Signals Grid -->
<div id="scalp-signals-container">
    <div class="loading">Loading scalping signals...</div>
</div>

<script>
// Scalping Page Logic
const ScalpingPage = {
    signals: [],
    minConfidence: 0.70,
    maxPrice: 5.00,

    async init() {
        console.log('Initializing Scalping page');

        // Set up event listeners
        document.getElementById('scalp-refresh-btn').addEventListener('click', () => this.loadSignals());
        document.getElementById('scalp-min-confidence').addEventListener('change', (e) => {
            this.minConfidence = parseFloat(e.target.value);
            this.loadSignals();
        });
        document.getElementById('scalp-max-price').addEventListener('change', (e) => {
            this.maxPrice = parseFloat(e.target.value);
            this.loadSignals();
        });

        // Load initial data
        await this.loadMarketStatus();
        await this.loadSignals();
        await this.loadStats();

        // Auto-refresh every 30 seconds
        setInterval(() => this.loadSignals(), 30000);

        // Update market status every 60 seconds
        setInterval(() => this.loadMarketStatus(), 60000);

        // Update countdown every second
        setInterval(() => this.updateCountdown(), 1000);
    },

    async loadMarketStatus() {
        try {
            const response = await fetch('/api/market/status');
            const status = await response.json();

            const banner = document.getElementById('market-status-banner');
            const icon = document.getElementById('market-status-icon');
            const text = document.getElementById('market-status-text');
            const time = document.getElementById('market-status-time');

            // Store status for countdown
            this.marketStatus = status;

            if (status.session === 'REGULAR') {
                // Market is open
                banner.style.border = '2px solid var(--success-color)';
                banner.style.background = 'rgba(34, 197, 94, 0.1)';
                icon.textContent = 'üü¢';
                text.textContent = 'Market is OPEN';
                text.style.color = 'var(--success-color)';
                time.textContent = `Closes at ${status.market_close}`;
            } else if (status.session === 'PRE_MARKET') {
                banner.style.border = '2px solid var(--warning-color)';
                banner.style.background = 'rgba(251, 191, 36, 0.1)';
                icon.textContent = 'üü°';
                text.textContent = 'Pre-Market';
                text.style.color = 'var(--warning-color)';
                time.textContent = `Market opens at ${status.market_open}`;
            } else if (status.session === 'AFTER_HOURS') {
                banner.style.border = '2px solid var(--warning-color)';
                banner.style.background = 'rgba(251, 191, 36, 0.1)';
                icon.textContent = 'üü°';
                text.textContent = 'After Hours';
                text.style.color = 'var(--warning-color)';
                time.textContent = `Market opens tomorrow at ${status.market_open}`;
            } else {
                // Market is closed
                banner.style.border = '2px solid var(--error-color)';
                banner.style.background = 'rgba(239, 68, 68, 0.1)';
                icon.textContent = 'üî¥';
                text.textContent = 'Market is CLOSED';
                text.style.color = 'var(--error-color)';
                time.textContent = status.next_open ? `Opens ${status.next_open}` : 'Closed for weekend';
            }
        } catch (error) {
            console.error('Error loading market status:', error);
        }
    },

    updateCountdown() {
        if (!this.marketStatus) return;

        const countdown = document.getElementById('market-countdown');
        if (!countdown) return;

        const now = new Date();
        let targetTime;

        if (this.marketStatus.session === 'REGULAR') {
            // Countdown to market close
            targetTime = new Date(now.toDateString() + ' ' + this.marketStatus.market_close);
        } else {
            // Countdown to market open
            const openTime = this.marketStatus.market_open;
            targetTime = new Date(now.toDateString() + ' ' + openTime);

            // If open time is in the past, it's tomorrow
            if (targetTime < now) {
                targetTime = new Date(targetTime.getTime() + 24 * 60 * 60 * 1000);
            }
        }

        const diff = targetTime - now;

        if (diff <= 0) {
            countdown.textContent = '';
            return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        if (this.marketStatus.session === 'REGULAR') {
            countdown.textContent = `Closes in ${hours}h ${minutes}m ${seconds}s`;
        } else {
            countdown.textContent = `Opens in ${hours}h ${minutes}m ${seconds}s`;
        }
    },

    async loadSignals() {
        try {
            const response = await fetch(`/api/options/signals?strategy=SCALPING&min_confidence=${this.minConfidence}&max_price=${this.maxPrice}&max_results=20`);
            const rawSignals = await response.json();

            // Transform API response to flatten nested structure
            const signals = rawSignals.map(s => ({
                ...s,
                symbol: s.contract?.symbol || 'N/A',
                strike: s.contract?.strike || 0,
                suggested_entry: s.entry_price || 0,
                delta: s.contract?.greeks?.delta || 0,
                iv_rank: s.contract?.iv_metrics?.iv_rank || 0,
                dte: this.calculateDTE(s.contract?.expiration),
                target_profit_percent: this.calculateProfitPercent(s.entry_price, s.target_price),
                stop_loss_percent: this.calculateProfitPercent(s.entry_price, s.stop_loss)
            }));

            this.signals = signals;
            this.renderSignals(signals);
        } catch (error) {
            console.error('Error loading signals:', error);
            document.getElementById('scalp-signals-container').innerHTML = '<div class="empty-state">Error loading signals</div>';
        }
    },

    calculateDTE(expirationDate) {
        if (!expirationDate) return 0;
        const expiry = new Date(expirationDate);
        const now = new Date();
        const diffTime = Math.abs(expiry - now);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    },

    calculateProfitPercent(entry, target) {
        if (!entry || entry === 0) return 0;
        return ((target - entry) / entry) * 100;
    },

    async loadStats() {
        try {
            const response = await fetch('/api/paper/stats');
            const stats = await response.json();

            document.getElementById('scalp-active-count').textContent = this.signals.length;
            document.getElementById('scalp-avg-confidence').textContent =
                this.signals.length > 0
                    ? (this.signals.reduce((sum, s) => sum + s.confidence, 0) / this.signals.length * 100).toFixed(0) + '%'
                    : '0%';

            // Count scalping signals in paper trading
            const scalpingInPaper = stats.strategies?.SCALPING?.sample_size || 0;
            document.getElementById('scalp-paper-count').textContent = scalpingInPaper;

            // Win rate from paper trading stats
            const winRate = stats.strategies?.SCALPING?.win_rate || 0;
            document.getElementById('scalp-win-rate').textContent = (winRate * 100).toFixed(1) + '%';
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    },

    renderSignals(signals) {
        const container = document.getElementById('scalp-signals-container');

        if (!signals || signals.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö°</div>
                    <p>No scalping signals found at ${(this.minConfidence * 100).toFixed(0)}% confidence</p>
                    <p class="text-muted">Try lowering the minimum confidence threshold</p>
                </div>
            `;
            return;
        }

        container.innerHTML = signals.map(signal => this.renderSignalCard(signal)).join('');

        // Attach event listeners to quick-add buttons
        signals.forEach(signal => {
            const btn = document.getElementById(`quick-add-${signal.signal_id}`);
            if (btn) {
                btn.addEventListener('click', () => this.quickAddToPaper(signal));
            }
        });
    },

    renderSignalCard(signal) {
        const confidenceClass = signal.confidence >= 0.90 ? 'confidence-high' : 'confidence-medium';
        const actionColor = signal.action.includes('CALL') ? 'var(--success-color)' : 'var(--danger-color)';

        // Calculate match score based on user preferences
        const matchScore = this.calculateMatchScore(signal);
        const matchClass = matchScore >= 90 ? 'match-perfect' : matchScore >= 75 ? 'match-good' : matchScore >= 60 ? 'match-ok' : 'match-poor';
        const matchLabel = matchScore >= 90 ? 'Perfect Match' : matchScore >= 75 ? 'Good Match' : matchScore >= 60 ? 'Partial Match' : 'Poor Match';

        return `
            <div class="signal-card">
                <div class="signal-header">
                    <div>
                        <div class="signal-symbol">${signal.symbol}</div>
                        <div class="text-muted" style="font-size: 0.875rem;">${signal.strategy}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div class="match-badge ${matchClass}" title="${matchLabel}">
                            ${matchScore}% Match
                        </div>
                        <div class="signal-confidence ${confidenceClass}">
                            ${(signal.confidence * 100).toFixed(0)}% Confidence
                        </div>
                    </div>
                </div>

                <div class="signal-details">
                    <div class="signal-detail">
                        <span class="signal-detail-label">Action:</span>
                        <span class="signal-detail-value" style="color: ${actionColor};">${signal.action}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Strike:</span>
                        <span class="signal-detail-value">$${signal.strike.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Entry:</span>
                        <span class="signal-detail-value">$${signal.suggested_entry.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Target:</span>
                        <span class="signal-detail-value text-success">$${signal.target_price.toFixed(2)} (+${signal.target_profit_percent.toFixed(0)}%)</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Stop:</span>
                        <span class="signal-detail-value text-danger">$${signal.stop_loss.toFixed(2)} (${signal.stop_loss_percent.toFixed(0)}%)</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">DTE:</span>
                        <span class="signal-detail-value">${signal.dte} days</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Delta:</span>
                        <span class="signal-detail-value">${signal.delta.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">IV Rank:</span>
                        <span class="signal-detail-value">${signal.iv_rank.toFixed(0)}%</span>
                    </div>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <strong>Reasoning:</strong>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">${signal.reasoning}</p>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-primary" id="quick-add-${signal.signal_id}" style="flex: 1;">
                        ‚ûï Quick Add to Paper Trading
                    </button>
                    <button class="btn btn-success btn-sm" onclick="alert('Real trading coming soon!')">
                        üöÄ Trade Live
                    </button>
                </div>
            </div>
        `;
    },

    async quickAddToPaper(signal) {
        const btn = document.getElementById(`quick-add-${signal.signal_id}`);
        const originalText = btn.innerHTML;

        try {
            btn.innerHTML = '‚è≥ Adding...';
            btn.disabled = true;

            const response = await fetch('/api/paper/quick-add-signal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signal)
            });

            const result = await response.json();

            if (result.status === 'added') {
                btn.innerHTML = '‚úÖ Added to Paper Trading!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');

                // Reload stats
                await this.loadStats();

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);
            } else if (result.status === 'already_exists') {
                btn.innerHTML = '‚úì Already in Paper Trading';
                btn.disabled = true;
            }
        } catch (error) {
            console.error('Error adding to paper trading:', error);
            btn.innerHTML = '‚ùå Error';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }
    },

    calculateMatchScore(signal) {
        // Load user preferences
        const saved = localStorage.getItem('tradefly_preferences');
        if (!saved) return 100; // No preferences = all signals match 100%

        const prefs = JSON.parse(saved);
        let score = 100;

        // DTE match (30 points)
        if (prefs.dtePreference === 'scalp' && signal.dte > 7) score -= 30;
        if (prefs.dtePreference === 'short' && (signal.dte < 7 || signal.dte > 30)) score -= 30;
        if (prefs.dtePreference === 'medium' && (signal.dte < 30 || signal.dte > 90)) score -= 30;
        if (prefs.dtePreference === 'leaps' && signal.dte < 90) score -= 30;

        // Delta match (25 points)
        const delta = Math.abs(signal.delta || 0);
        if (prefs.strikePreference === 'deep-itm' && delta < 0.80) score -= 25;
        if (prefs.strikePreference === 'slight-itm' && (delta < 0.55 || delta > 0.80)) score -= 25;
        if (prefs.strikePreference === 'atm' && (delta < 0.45 || delta > 0.55)) score -= 25;
        if (prefs.strikePreference === 'slight-otm' && (delta < 0.30 || delta > 0.45)) score -= 25;
        if (prefs.strikePreference === 'far-otm' && delta > 0.30) score -= 25;

        // Premium match (25 points)
        const premium = signal.suggested_entry || 0;
        if (prefs.premiumBudget === 'conservative' && premium > 2) score -= 25;
        if (prefs.premiumBudget === 'moderate' && (premium < 2 || premium > 5)) score -= 25;
        if (prefs.premiumBudget === 'aggressive' && (premium < 5 || premium > 10)) score -= 25;
        if (prefs.premiumBudget === 'high-roller' && premium < 10) score -= 25;

        // Confidence match (20 points)
        const confidence = (signal.confidence || 0) * 100;
        if (confidence < prefs.minConfidence) score -= 20;

        return Math.max(0, Math.round(score));
    }
};

// Initialize when page loads
ScalpingPage.init();
</script>

<style>
.match-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
    white-space: nowrap;
}

.match-perfect {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.match-good {
    background: rgba(59, 130, 246, 0.2);
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.match-ok {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid #f59e0b;
}

.match-poor {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}
</style>
